# 红黑树(Red Black Tree)

[TOC]

## 1.  红黑树概述

### 1.1 B树

B树是一种平衡的多路搜索树，多用于文件系统，数据库的实现

#### 1.1.1 B树的特点

1. 1个节点可以存储超过2个元素，可以拥有超过2个子节点
2. 拥有二叉搜索树的性质
3. 平衡、每个节点的所有子树高度一致
4. 高度较矮

#### 1.1.2 B树的性质

1. m阶B树：即每个子节点最多拥有三个子节点
2. 假设一个节点存储的元素为`x`：根节点`1<= x<= m-1`，非根节点：`ceil(m/2) -1 <= x <= m-1`
3. 如果有子节点，子节点个数`y = x + 1`
4. 如果是根节点`2 <= y <= m`
5. 如果是非根节点：`ceiling(m/2) <= y <= m`

如果`m = 2`，那`B`树是一棵二叉树搜索树

如果是数据库的话，一般为`200 ~ 300`阶的B树

#### 1.1.3 B树与二叉搜索树

**合并**

对于二叉搜索树多代合并，会得到一个超级节点

- 2代合并的超级节点最多有4个子节点(至少是4阶B树)
- 3代合并的超级节点最多有8个子节点(至少是8阶B树)
- n代合并的超级节点最多有`2^n`个子节点

**B树搜索查找**

跟二叉搜索树树的搜索类似

- 先在节点内部从小到大开始搜索元素
- 如果命中，搜索结束
- 如果命中，再去对应的子节点中搜索元素，重复步骤1

**添加**

- 新添加的元素必定是添加到叶子节点
- 对于某一个元素添加到叶子节点时，发现叶子节点内的元素数量小于`m-1`，直接放入此节点即可
- 如果添加到的叶子节点的元素数量已经等于`m-1`，则会产生**上溢**的情况

**上溢解决**

- 将当前节点插入到叶子节点
- 求出上溢节点最中间元素的位置`k`
- 将`k`位置的元素向上与父节点合并
- 将`[0, k-1]`和`[k+1, m-1]`位置的元素分裂成`2`个子节点
- 一次分裂完毕后，有可能导致父节点上溢，依然按照上述方法解决
- 最极端的情况，有可能一致分裂到根节点

**删除**

- 如果需要删除的元素在叶子节点中，直接删除
- 如果删除非叶子节点
  1. 先找到前驱或者后继，覆盖所需要删除元素的值
  2. 再把前驱或后继元素删除
- 非叶子节点的前驱或后继元素，必定在叶子节点中

**下溢**

- 叶子节点被删除一个元素后，元素个数可能会低于最低限制`ceil(m/2) -1 <= x <= m-1`，称之为下溢

- 下溢节点的元素数量必然等于`ceil(m/2) - 2`

- 如果下溢节点临近的兄弟节点，有至少`ceil(m/2)`个元素，可以向其接一个元素

  假设父节点中指向当前下溢节点的元素为`b`，兄弟节点的最大元素为`a`

  可以用兄弟节点的元素`a`替换父节点的元素`b`，再将`b`元素放入下溢的节点的首位

- 如果下溢节点临近的兄弟节点，只有`ceil(m/2) - 1`个元素

  将父节点的元素`b`跟左右子节点进行合并

  合并后的节点元素个数等于`ceil(m / 2) + ceil(m / 2) - 2`，不超过`m - 1`

  这个操作可能会导致父节点下溢，依然按照上述方法解决，极端情况根节点也会下溢

**二叉搜索树**

```mermaid
graph TD
18 --> 12
18 --> 33
12 --> 10
12 --> 15
33 --> 23
33 --> 48
23 --> 20
23 --> 30
48 --> 45
48 --> 50
45 --> 45L[null]
45 --> 47
50 --> 50L[null]
50 --> 52
20 --> 20L[null]
20 --> 21
30 --> 24
30 --> 31
```

**3阶B树**

```mermaid
graph TD
18_33 --> 12
18_33 --> 23_30
12 --> 10
12 --> 15
23_30 --> 20_21
23_30 --> 24
23_30 --> 31
18_33 --> 48
48 --> 45_47
48 --> 50_52
```

红黑树也是一种自平衡二叉搜索树

红黑树必须满足一下5条性质

1. 节点`RED`或者`BLACK`
2. 根节点是`BLACK`
3. 叶子节点(外部节点、空节点)都是`BLACK`
4. `RED`节点的子节点都是`BLACK`，即`RED`节点的`parent`都是`BLACK`

```mermaid
graph TD
53B --> 34R
53B --> 80R
34R --> 18B
34R --> 46B
18B --> 17R
18B --> 33R
33R --> L33[LnullB]
33R --> R33[RnullB]
17R --> L17[LnullB]
17R --> R17[RnullB]
46B --> L46[LnullB]
46B --> 50R
50R --> L50[LnullB]
50R --> R50[RnullB]
80R --> 74B
80R --> 88B
74B --> 72R
74B --> R74[RnullB]
72R --> L72[LnullB]
72R --> R72[RnullB]
88B --> L88[LnullB]
88B --> R88[RnullB]
```

5. 从任一节点到叶子节点的所有路径都包含相同数目的`BLACK`节点

